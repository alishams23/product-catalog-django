name: Docker Compose CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  compose:
    runs-on: self-hosted
    env:
      COMPOSE_PROJECT_NAME: product-catalog-ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env from GitHub secrets
        run: |
          cat > .env <<'EOF'
          DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
          DJANGO_DEBUG=${{ secrets.DJANGO_DEBUG }}
          DJANGO_ALLOWED_HOSTS=${{ secrets.DJANGO_ALLOWED_HOSTS }}
          DJANGO_SECURE_COOKIES=${{ secrets.DJANGO_SECURE_COOKIES }}
          DJANGO_CSRF_TRUSTED_ORIGINS=${{ secrets.DJANGO_CSRF_TRUSTED_ORIGINS }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
          EOF

      - name: Clean previous stack
        run: docker compose -f docker-compose.yml down --remove-orphans || true

      - name: Build and start services
        run: docker compose -f docker-compose.yml up --build -d

      - name: Show running services
        run: docker compose -f docker-compose.yml ps

      - name: Tail logs on failure
        if: failure()
        run: docker compose -f docker-compose.yml logs --no-color

      # Intentionally keep services running on the self-hosted runner for testing.
